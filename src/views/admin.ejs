<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>JunkQuote Admin</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background-color: #f7f7f7;
        color: #222;
      }
      h1,
      h2 {
        margin-bottom: 0.5rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 2rem;
        background-color: #fff;
      }
      th,
      td {
        padding: 0.5rem;
        border: 1px solid #ddd;
        vertical-align: top;
      }
      th {
        background-color: #f0f0f0;
        text-align: left;
      }
      .section {
        margin-bottom: 3rem;
      }
      .muted {
        color: #555;
      }
      .badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-size: 0.75rem;
      }
      .badge.pending {
        background-color: #fde68a;
      }
      .badge.booked {
        background-color: #bbf7d0;
      }
      .photos img {
        max-width: 120px;
        margin-right: 0.5rem;
        border: 1px solid #ccc;
      }
      .notes {
        list-style: disc;
        padding-left: 1.5rem;
      }
    </style>
  </head>
  <body>
    <h1>JunkQuote Admin</h1>

    <section class="section">
      <h2>Approvals Queue</h2>
      <table>
        <thead>
          <tr>
            <th>Quote</th>
            <th>Lead</th>
            <th>Total</th>
            <th>Flags</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody>
          <% if (approvals.length === 0) { %>
          <tr>
            <td colspan="5" class="muted">No approvals awaiting action.</td>
          </tr>
          <% } %> <% approvals.forEach(function (approval) { %>
          <tr>
            <td><%= approval.quoteId %></td>
            <td>
              <strong><%= approval.quote.lead.name || 'Unknown' %></strong
              ><br />
              <span class="muted"><%= approval.quote.lead.address || 'No address yet' %></span>
            </td>
            <td>$<%= approval.quote.total.toFixed(2) %></td>
            <td>
              <code><%= JSON.stringify(approval.quote.flagsJson || {}) %></code>
            </td>
            <td>
              <a href="/api/approve/<%= approval.token %>?decision=approve">Approve</a>
              |
              <a href="/api/approve/<%= approval.token %>?decision=deny">Deny</a>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>

    <section class="section">
      <h2>Leads &amp; Quotes</h2>
      <table>
        <thead>
          <tr>
            <th>Lead</th>
            <th>Quotes</th>
            <th>Jobs</th>
            <th>Recent Photos</th>
          </tr>
        </thead>
        <tbody>
          <% leads.forEach(function (lead) { %>
          <tr>
            <td>
              <strong><%= lead.name || 'Messenger lead' %></strong><br />
              <span class="muted">Stage: <%= lead.stage %></span><br />
              <span class="muted">Messenger PSID: <%= lead.messengerPsid %></span><br />
              <span class="muted">Address: <%= lead.address || 'Pending' %></span><br />
              <span class="muted">Curbside: <%= lead.curbside ? 'Yes' : 'No' %></span><br />
              <span class="muted">Updated: <%= lead.updatedAt.toISOString() %></span>
            </td>
            <td>
              <% if (lead.quotes.length === 0) { %>
              <span class="muted">No quotes yet.</span>
              <% } %> <% lead.quotes.forEach(function (quote) { %>
              <div style="margin-bottom: 1rem;">
                <strong>Quote <%= quote.id %></strong>
                <span class="badge <%= quote.status %>"><%= quote.status %></span><br />
                Total: $<%= quote.total.toFixed(2) %>
                (Confidence <%= quote.confidence.toFixed(2) %>)<br />
                <em>Line items:</em>
                <ul class="notes">
                  <% quote.lineItemsJson.forEach(function (item) { %>
                  <li><%= item.label %> — $<%= item.amount.toFixed(2) %></li>
                  <% }) %>
                </ul>
                <% if (quote.discountsJson.length > 0) { %>
                <em>Discounts:</em>
                <ul class="notes">
                  <% quote.discountsJson.forEach(function (discount) { %>
                  <li><%= discount.label %> — $<%= discount.amount.toFixed(2) %></li>
                  <% }) %>
                </ul>
                <% } %>
                <em>Notes:</em>
                <ul class="notes">
                  <% (quote.notesJson || []).forEach(function (note) { %>
                  <li><%= note %></li>
                  <% }) %>
                </ul>
              </div>
              <% }) %>
            </td>
            <td>
              <% if (lead.jobs.length === 0) { %>
              <span class="muted">No job scheduled.</span>
              <% } %> <% lead.jobs.forEach(function (job) { %>
              <div>
                <strong><%= job.id %></strong><br />
                Window: <%= job.windowStart.toISOString() %> →
                <%= job.windowEnd.toISOString() %><br />
                <span class="badge <%= job.status %>"><%= job.status %></span><br />
                Reminder: <%= job.reminderScheduledAt
                  ? job.reminderScheduledAt.toISOString()
                  : 'n/a' %>
              </div>
              <% }) %>
            </td>
            <td class="photos">
              <% const photoAudits = audits.filter(function (audit) { return audit.leadId === lead.id && audit.payload.attachments && audit.payload.attachments.length; }).slice(0, 3); %>
              <% if (photoAudits.length === 0) { %>
              <span class="muted">No photos stored.</span>
              <% } else { %>
              <% photoAudits.forEach(function (audit) { %>
              <% audit.payload.attachments.forEach(function (url) { %>
              <img src="<%= url %>" alt="Attachment" />
              <% }) %>
              <% }) %>
              <% } %>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>

    <section class="section">
      <h2>Recent Activity</h2>
      <table>
        <thead>
          <tr>
            <th>When</th>
            <th>Lead</th>
            <th>Actor</th>
            <th>Action</th>
            <th>Payload</th>
          </tr>
        </thead>
        <tbody>
          <% audits.forEach(function (audit) { %>
          <tr>
            <td><%= audit.createdAt.toISOString() %></td>
            <td><%= audit.lead?.name || audit.leadId || 'n/a' %></td>
            <td><%= audit.actor %></td>
            <td><%= audit.action %></td>
            <td><code><%= JSON.stringify(audit.payload) %></code></td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>
  </body>
</html>
