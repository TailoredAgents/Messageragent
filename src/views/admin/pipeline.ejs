<section class="section">
  <div class="section__header">
    <h3 class="section__title">Stage Overview</h3>
    <p class="section__subtitle">
      Monitor how many leads sit in each Stonegate workflow stage.
    </p>
  </div>
  <div class="stage-grid">
    <% stageBreakdown.forEach(function (stage) { %>
    <div class="stage-card stage-card--<%= stage.tone %>">
      <header class="stage-card__header">
        <div>
          <span class="stage-card__label"><%= stage.label %></span>
          <p class="stage-card__caption"><%= stage.caption %></p>
        </div>
        <span class="stage-card__count"><%= stage.count %></span>
      </header>
      <div class="stage-card__progress">
        <div
          class="stage-card__progress-fill"
          style="width: <%= stage.percent %>%;"
        ></div>
      </div>
      <footer class="stage-card__footer">
        <span><%= stage.percent.toFixed(0) %>% of pipeline</span>
        <% if (stage.trendLabel) { %>
        <span class="stage-card__trend"><%= stage.trendLabel %></span>
        <% } %>
      </footer>
    </div>
    <% }) %>
  </div>
</section>

<section class="section">
  <div class="section__header">
    <h3 class="section__title">Lead Pipeline</h3>
    <p class="section__subtitle">
      Recent conversations with quote, stage, and media context for quick action.
    </p>
  </div>
  <div class="card table-card">
    <table class="data-table data-table--leads">
      <thead>
        <tr>
          <th scope="col">Lead</th>
          <th scope="col">Stage</th>
          <th scope="col">Quote</th>
          <th scope="col">Photos</th>
          <th scope="col">Next Step</th>
        </tr>
      </thead>
      <tbody>
        <% if (pipelineRows.length === 0) { %>
        <tr>
          <td colspan="5" class="data-table__empty">
            No leads yet - connect Messenger to start capturing junk removal
            requests.
          </td>
        </tr>
        <% } else { %> <% pipelineRows.forEach(function (lead) { %>
        <tr>
          <td>
            <div class="table-stack">
              <span class="table-stack__title"><%= lead.displayName %></span>
              <span class="table-stack__meta"
                ><%= lead.channelLabel %> | Updated <%= lead.updatedAgo %></span
              >
              <span class="table-stack__meta"
                ><%= lead.address || 'Address pending' %></span
              >
            </div>
          </td>
          <td>
            <span class="status-badge status-badge--<%= lead.stageClass %>"
              ><%= lead.stageLabel %></span
            >
          </td>
          <td>
            <% if (lead.quoteSummary) { %>
            <div class="table-value">
              <span class="table-value__primary"
                ><%= lead.quoteSummary.totalDisplay %></span
              >
              <span class="table-value__meta"
                ><%= lead.quoteSummary.statusLabel %> | Confidence
                <%= lead.quoteSummary.confidence %></span
              >
              <% if (lead.quoteSummary.needsApproval) { %>
              <span class="pill pill--warning">Needs approval</span>
              <% } %>
            </div>
            <% } else { %>
            <span class="pill pill--neutral">No quote yet</span>
            <% } %>
          </td>
          <td>
            <div class="photo-group">
              <% if (lead.attachments.length === 0) { %>
              <span class="pill pill--neutral">Awaiting photos</span>
              <% } else { %> <% lead.attachments.forEach(function (url) { %>
              <img
                class="photo-group__item"
                src="<%= url %>"
                alt="Lead attachment"
                loading="lazy"
              />
              <% }); %> <% } %>
            </div>
          </td>
          <td>
            <div class="table-stack">
              <span class="table-stack__title"><%= lead.nextAction %></span>
              <span class="table-stack__meta"><%= lead.contactSummary %></span>
            </div>
          </td>
        </tr>
        <% }); %> <% } %>
      </tbody>
    </table>
  </div>
</section>
