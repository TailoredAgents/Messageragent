generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Channel {
  messenger
  sms
}

enum LeadStage {
  awaiting_photos
  clarifying
  quoting
  awaiting_owner
  scheduling
  booked
  reminding
  done
}

enum QuoteStatus {
  draft
  pending_approval
  approved
  denied
  sent
  accepted
}

enum JobStatus {
  tentative
  booked
  completed
  cancelled
}

enum ApprovalStatus {
  pending
  approved
  denied
}

enum MessageRole {
  user
  assistant
  system
  tool
}

model Lead {
  id                       String      @id @default(uuid())
  channel                  Channel
  customerId               String      @map("customer_id")
  name                     String?
  messengerPsid            String?     @unique
  phone                    String?
  email                    String?
  address                  String?
  lat                      Float?
  lng                      Float?
  curbside                 Boolean     @default(false)
  stage                    LeadStage   @default(awaiting_photos)
  stateMetadata            Json?       @db.JsonB
  lastCustomerMessageAt    DateTime?   @map("last_customer_message_at")
  lastAgentMessageAt       DateTime?   @map("last_agent_message_at")
  createdAt                DateTime    @default(now()) @map("created_at")
  updatedAt                DateTime    @updatedAt @map("updated_at")

  customer                 Customer    @relation(fields: [customerId], references: [id], onDelete: Restrict)
  quotes                   Quote[]
  jobs                     Job[]
  audits                   Audit[]
  attachments              LeadAttachment[]
  conversations            Conversation[]

  @@index([channel])
  @@index([stage])
  @@index([customerId])
}

model Quote {
  id               String        @id @default(uuid())
  leadId           String        @map("lead_id")
  featuresJson     Json          @map("features_json") @db.JsonB
  lineItemsJson    Json          @map("line_items_json") @db.JsonB
  discountsJson    Json          @map("discounts_json") @db.JsonB
  subtotal         Decimal       @db.Decimal(10, 2)
  total            Decimal       @db.Decimal(10, 2)
  confidence       Decimal       @db.Decimal(3, 2)
  needsApproval    Boolean       @map("needs_approval") @default(false)
  status           QuoteStatus   @default(draft)
  flagsJson        Json?         @map("flags_json") @db.JsonB
  notesJson        Json?         @map("notes_json") @db.JsonB
  disclaimer       String?
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  lead             Lead          @relation(fields: [leadId], references: [id])
  approvalRequests Approval[]
  job              Job?

  @@index([leadId])
  @@index([status])
}

model Job {
  id                 String     @id @default(uuid())
  leadId             String     @map("lead_id")
  customerId         String     @map("customer_id")
  quoteId            String?    @map("quote_id") @unique
  windowStart        DateTime   @map("window_start")
  windowEnd          DateTime   @map("window_end")
  status             JobStatus  @default(tentative)
  reminderScheduledAt DateTime? @map("reminder_scheduled_at")
  reminderSentAt     DateTime?  @map("reminder_sent_at")
  googleCalendarId   String?    @map("google_calendar_id")
  googleEventId      String?    @map("google_event_id") @unique
  googleEventICalUid String?    @map("google_event_ical_uid")
  googleEventEtag    String?    @map("google_event_etag")
  googleEventHtmlLink String?   @map("google_event_html_link")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  lead      Lead      @relation(fields: [leadId], references: [id])
  customer  Customer  @relation(fields: [customerId], references: [id], onDelete: Restrict)
  quote     Quote?    @relation(fields: [quoteId], references: [id])
  items     JobItem[]
  events    JobEvent[]

  @@index([leadId])
  @@index([customerId])
  @@index([windowStart])
  @@index([status])
}

model CalendarSyncState {
  id         String   @id @default(uuid())
  calendarId String   @unique @map("calendar_id")
  syncToken  String?  @map("sync_token")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
}

model Approval {
  id         String          @id @default(uuid())
  quoteId    String          @map("quote_id")
  token      String          @unique
  status     ApprovalStatus  @default(pending)
  approver   String?
  decidedAt  DateTime?       @map("decided_at")
  createdAt  DateTime        @default(now()) @map("created_at")

  quote Quote @relation(fields: [quoteId], references: [id])

  @@index([quoteId])
  @@index([status])
}

model Audit {
  id        String   @id @default(uuid())
  leadId    String?  @map("lead_id")
  actor     String
  action    String
  payload   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead? @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([createdAt])
}

model LeadAttachment {
  id        String   @id @default(uuid())
  leadId    String   @map("lead_id")
  url       String
  source    String
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id])

  @@unique([leadId, url])
  @@index([leadId, createdAt])
}

model Config {
  id             String   @id @default(uuid())
  tenantId       String   @unique @map("tenant_id")
  serviceArea    Json     @map("service_area") @db.JsonB
  pricebook      Json     @db.JsonB
  reminderHours  Int[]    @map("reminder_hours")
  quotePolicy    Json     @map("quote_policy") @db.JsonB
  channels       Json     @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
}

model AgentRuntimeState {
  id          String   @id @default(uuid())
  tenantId    String   @unique @map("tenant_id")
  agentPaused Boolean  @map("agent_paused") @default(false)
  updatedBy   String?  @map("updated_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

// Context Memory & Customer Models

model Customer {
  id        String   @id @default(uuid())
  name      String?
  phone     String?
  email     String?
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  leads         Lead[]
  jobs          Job[]
  addresses     CustomerAddress[]
  conversations Conversation[]
  memoryNotes   MemoryNote[]

  @@index([phone])
  @@index([email])
  @@index([createdAt])
}

model CustomerAddress {
  id         String   @id @default(uuid())
  customerId String   @map("customer_id")
  address    String
  city       String?
  state      String?
  zip        String?
  lat        Float?
  lng        Float?
  isPrimary  Boolean  @default(false) @map("is_primary")
  metadata   Json?    @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([customerId, isPrimary])
}

model Conversation {
  id            String    @id @default(uuid())
  customerId    String?   @map("customer_id")
  leadId        String?   @map("lead_id")
  channel       Channel
  externalId    String?   @map("external_id")
  startedAt     DateTime  @default(now()) @map("started_at")
  lastMessageAt DateTime? @map("last_message_at")
  closedAt      DateTime? @map("closed_at")
  metadata      Json?     @db.JsonB
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  messages Message[]

  @@unique([channel, externalId])
  @@index([customerId])
  @@index([leadId])
  @@index([lastMessageAt])
  @@index([startedAt])
}

model Message {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  role           MessageRole
  content        String      @db.Text
  metadata       Json?       @db.JsonB
  createdAt      DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@index([createdAt])
}

model MemoryNote {
  id             String    @id @default(uuid())
  customerId     String?   @map("customer_id")
  conversationId String?   @map("conversation_id")
  content        String    @db.Text
  metadata       Json?     @db.JsonB
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([expiresAt])
}

model JobItem {
  id          String   @id @default(uuid())
  jobId       String   @map("job_id")
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at")

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
}

model JobEvent {
  id        String   @id @default(uuid())
  jobId     String   @map("job_id")
  eventType String   @map("event_type")
  actor     String?
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([jobId, createdAt])
  @@index([eventType])
}
